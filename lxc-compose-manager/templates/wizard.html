{% extends "base.html" %}

{% block title %}Create Containers - LXC Compose Manager{% endblock %}

{% block extra_css %}
<style>
    .wizard-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .wizard-step {
        background: #f7fafc;
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 20px;
    }
    
    .wizard-step h3 {
        color: #2d3748;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .step-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        font-weight: bold;
        font-size: 14px;
    }
    
    .option-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .option-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    
    .option-card.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .option-card input[type="checkbox"] {
        margin-right: 10px;
    }
    
    .option-title {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 5px;
    }
    
    .option-description {
        color: #718096;
        font-size: 14px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #4a5568;
        font-weight: 500;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #cbd5e0;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .number-input {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .number-input button {
        width: 40px;
        height: 40px;
        border: 1px solid #cbd5e0;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 18px;
    }
    
    .number-input button:hover {
        background: #f7fafc;
    }
    
    .number-input input {
        width: 80px;
        text-align: center;
    }
    
    .services-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    
    .service-chip {
        background: #edf2f7;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 13px;
        color: #4a5568;
        text-align: center;
    }
    
    .wizard-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #e2e8f0;
    }
    
    .summary-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .summary-table th,
    .summary-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .summary-table th {
        background: #f7fafc;
        font-weight: 600;
        color: #4a5568;
    }
    
    .creating-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
    }
    
    .creating-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #2d2d2d;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        width: 90%;
        max-width: 1200px;
        height: 80vh;
        max-height: 800px;
        display: flex;
        flex-direction: column;
        color: #fff;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .progress-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 5px 0;
        padding: 8px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        text-align: left;
        color: #fff;
    }
    
    .progress-icon {
        width: 20px;
        height: 20px;
    }
    
    .progress-icon.pending {
        opacity: 0.3;
    }
    
    .progress-icon.success {
        color: #48bb78;
    }
    
    .progress-icon.error {
        color: #f56565;
    }
    
    .log-output {
        background: #000;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #444;
        text-align: left;
        font-family: 'Ubuntu Mono', 'Courier New', monospace;
        font-size: 13px;
        overflow-y: auto;
        flex: 1;
        margin-top: 15px;
        min-height: 300px;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.5;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .log-output .header {
        color: #ffa500;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .log-output .command {
        color: #888;
        font-style: italic;
        margin-bottom: 5px;
    }
    
    .log-output .stderr {
        color: #ff6b6b;
    }
    
    .log-output .stdout {
        color: #d4d4d4;
    }
    
    .log-output .success {
        color: #51cf66;
        font-weight: bold;
    }
    .nav-bar {
        background: #f7fafc;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .nav-links {
        display: flex;
        gap: 20px;
    }
    
    .nav-link {
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: color 0.3s;
    }
    
    .nav-link:hover {
        color: #764ba2;
    }
    
    .nav-link.active {
        font-weight: 600;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation Bar -->
<div class="nav-bar">
    <div class="nav-links">
        <a href="{{ url_for('index') }}" class="nav-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            Dashboard
        </a>
        <a href="{{ url_for('wizard') }}" class="nav-link active">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
            </svg>
            Create Containers
        </a>
        <a href="{{ url_for('terminal') }}" class="nav-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 17 10 11 4 5"></polyline>
                <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            Terminal
        </a>
    </div>
    <div style="color: #666; font-size: 12px;">
        Container Creation Wizard
    </div>
</div>

<div class="wizard-container">
    <h2 style="margin-bottom: 30px;">Container Creation Wizard</h2>
    
    <!-- Step 1: Datastore -->
    <div class="wizard-step">
        <h3>
            <span class="step-number">1</span>
            Database & Cache Services
        </h3>
        
        <div class="option-card" onclick="toggleDatastore(this)">
            <label style="cursor: pointer; display: flex; align-items: flex-start;">
                <input type="checkbox" id="create_datastore" style="margin-top: 2px;">
                <div>
                    <div class="option-title">Create Datastore Container</div>
                    <div class="option-description">
                        PostgreSQL database server and Redis cache in a single container.
                        This will be accessible to all application containers.
                    </div>
                    <div class="services-grid">
                        <span class="service-chip">PostgreSQL 14</span>
                        <span class="service-chip">Redis 7</span>
                        <span class="service-chip">IP: 10.0.3.2</span>
                    </div>
                </div>
            </label>
        </div>
        
        <div id="datastoreOptions" style="display: none; margin-top: 20px;">
            <div class="form-group">
                <label>PostgreSQL Version</label>
                <select id="postgres_version">
                    <option value="14">PostgreSQL 14 (Recommended)</option>
                    <option value="13">PostgreSQL 13</option>
                    <option value="15">PostgreSQL 15</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Step 2: Application Containers -->
    <div class="wizard-step">
        <h3>
            <span class="step-number">2</span>
            Application Containers
        </h3>
        
        <div class="form-group">
            <label>Number of Application Containers</label>
            <div class="number-input">
                <button type="button" onclick="changeAppCount(-1)">−</button>
                <input type="number" id="app_count" value="1" min="0" max="10" readonly>
                <button type="button" onclick="changeAppCount(1)">+</button>
            </div>
            <div style="margin-top: 10px; color: #718096; font-size: 14px;">
                Each container will have nginx, Python, and Node.js installed
            </div>
        </div>
        
        <div id="appContainersList" style="margin-top: 20px;">
            <!-- Dynamically populated -->
        </div>
    </div>
    
    <!-- Step 3: Sample Applications -->
    <div class="wizard-step">
        <h3>
            <span class="step-number">3</span>
            Sample Applications
        </h3>
        
        <div class="option-card" onclick="toggleOption(this, 'create_django_sample')">
            <label style="cursor: pointer; display: flex; align-items: flex-start;">
                <input type="checkbox" id="create_django_sample" style="margin-top: 2px;">
                <div>
                    <div class="option-title">Deploy Django + Celery Sample</div>
                    <div class="option-description">
                        A complete Django application with Celery task queue, 
                        connected to PostgreSQL and Redis. Deploys to app-1 container.
                    </div>
                    <div class="services-grid">
                        <span class="service-chip">Django 4.2</span>
                        <span class="service-chip">Celery</span>
                        <span class="service-chip">Nginx</span>
                        <span class="service-chip">Supervisor</span>
                    </div>
                </div>
            </label>
        </div>
    </div>
    
    <!-- Step 4: Review -->
    <div class="wizard-step">
        <h3>
            <span class="step-number">4</span>
            Review & Create
        </h3>
        
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Container</th>
                    <th>Type</th>
                    <th>IP Address</th>
                    <th>Services</th>
                </tr>
            </thead>
            <tbody id="summaryTable">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>
    
    <div class="wizard-actions">
        <a href="{{ url_for('index') }}" class="btn">Cancel</a>
        <button class="btn btn-primary" onclick="createContainers()">Create Containers</button>
    </div>
</div>

<!-- Creating overlay -->
<div id="creatingOverlay" class="creating-overlay">
    <div class="creating-content">
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
            <div class="spinner"></div>
            <div style="text-align: left;">
                <h2 style="margin: 0; color: #fff;">Creating Containers</h2>
                <p style="margin: 5px 0 0 0; color: #aaa;">Setting up your LXC environment...</p>
            </div>
        </div>
        
        <div id="progressList" style="margin-bottom: 15px;">
            <!-- Progress items will be added here -->
        </div>
        
        <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0; color: #aaa; font-size: 14px;">Installation Log</h4>
                <span id="logStatus" style="color: #888; font-size: 12px;">Initializing...</span>
            </div>
            <div id="logOutput" class="log-output">
                <div style="color: #888;">Waiting for container creation to start...</div>
            </div>
        </div>
        
        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div id="statusMessage" style="color: #aaa; font-size: 14px;"></div>
            <div>
                <button class="btn btn-secondary" onclick="cancelCreation()" id="cancelBtn" 
                        style="margin-right: 10px;">Cancel</button>
                <button class="btn btn-primary" onclick="closeOverlay()" id="doneBtn" 
                        style="display: none; min-width: 100px;">Done</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
function toggleDatastore(card) {
    const checkbox = card.querySelector('input[type="checkbox"]');
    const options = document.getElementById('datastoreOptions');
    
    if (checkbox.checked) {
        card.classList.add('selected');
        options.style.display = 'block';
    } else {
        card.classList.remove('selected');
        options.style.display = 'none';
    }
    
    updateSummary();
}

function toggleOption(card, checkboxId) {
    const checkbox = document.getElementById(checkboxId);
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        card.classList.add('selected');
    } else {
        card.classList.remove('selected');
    }
    
    updateSummary();
}

function changeAppCount(delta) {
    const input = document.getElementById('app_count');
    let value = parseInt(input.value) + delta;
    value = Math.max(0, Math.min(10, value));
    input.value = value;
    
    updateAppContainersList();
    updateSummary();
}

function updateAppContainersList() {
    const count = parseInt(document.getElementById('app_count').value);
    const list = document.getElementById('appContainersList');
    
    if (count === 0) {
        list.innerHTML = '<p style="color: #718096;">No application containers will be created</p>';
    } else {
        let html = '<div style="display: grid; gap: 10px;">';
        for (let i = 1; i <= count; i++) {
            html += `
                <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e2e8f0;">
                    <strong>app-${i}</strong> - IP: 10.0.3.${10 + i}
                </div>
            `;
        }
        html += '</div>';
        list.innerHTML = html;
    }
}

function updateSummary() {
    const tbody = document.getElementById('summaryTable');
    let html = '';
    
    // Datastore
    if (document.getElementById('create_datastore').checked) {
        html += `
            <tr>
                <td><strong>datastore</strong></td>
                <td>Database & Cache</td>
                <td>10.0.3.2</td>
                <td>PostgreSQL, Redis</td>
            </tr>
        `;
    }
    
    // App containers
    const appCount = parseInt(document.getElementById('app_count').value);
    for (let i = 1; i <= appCount; i++) {
        html += `
            <tr>
                <td><strong>app-${i}</strong></td>
                <td>Application</td>
                <td>10.0.3.${10 + i}</td>
                <td>nginx, Python, Node.js</td>
            </tr>
        `;
    }
    
    // Django sample
    if (document.getElementById('create_django_sample').checked && appCount > 0) {
        html += `
            <tr>
                <td colspan="4" style="background: #f0f4ff;">
                    <strong>Django Sample</strong> will be deployed to app-1
                </td>
            </tr>
        `;
    }
    
    if (html === '') {
        html = '<tr><td colspan="4" style="text-align: center; color: #718096;">No containers selected</td></tr>';
    }
    
    tbody.innerHTML = html;
}

let socket = null;
let creationInProgress = false;

function createContainers() {
    const data = {
        create_datastore: document.getElementById('create_datastore').checked,
        postgres_version: document.getElementById('postgres_version').value,
        app_count: parseInt(document.getElementById('app_count').value),
        create_django_sample: document.getElementById('create_django_sample').checked
    };
    
    if (!data.create_datastore && data.app_count === 0) {
        alert('Please select at least one container to create');
        return;
    }
    
    // Show progress overlay
    document.getElementById('creatingOverlay').style.display = 'block';
    document.getElementById('cancelBtn').style.display = 'inline-block';
    document.getElementById('doneBtn').style.display = 'none';
    const progressList = document.getElementById('progressList');
    const logOutput = document.getElementById('logOutput');
    progressList.innerHTML = '';
    logOutput.innerHTML = '';
    creationInProgress = true;
    
    // Add progress items
    if (data.create_datastore) {
        addProgressItem('datastore', 'Creating datastore container...');
    }
    for (let i = 1; i <= data.app_count; i++) {
        addProgressItem(`app-${i}`, `Creating app-${i} container...`);
    }
    if (data.create_django_sample) {
        addProgressItem('django', 'Deploying Django sample application...');
    }
    
    // Initialize WebSocket connection
    socket = io();
    
    // Handle progress updates
    socket.on('progress_update', function(data) {
        updateProgressItem(data.container, data.status === 'success', data.message);
    });
    
    // Handle log output
    socket.on('log_output', function(data) {
        const logDiv = document.getElementById('logOutput');
        const line = document.createElement('div');
        line.className = data.type || 'stdout';
        line.textContent = data.message;
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
        
        // Update status based on log type
        const logStatus = document.getElementById('logStatus');
        if (data.type === 'header') {
            logStatus.textContent = 'Processing...';
            logStatus.style.color = '#ffa500';
        } else if (data.type === 'success') {
            logStatus.textContent = 'Success';
            logStatus.style.color = '#51cf66';
        } else if (data.type === 'stderr' || data.type === 'error') {
            logStatus.textContent = 'Error detected';
            logStatus.style.color = '#ff6b6b';
        }
    });
    
    // Handle completion
    socket.on('creation_complete', function(data) {
        creationInProgress = false;
        document.getElementById('cancelBtn').style.display = 'none';
        document.getElementById('doneBtn').style.display = 'inline-block';
        
        const logDiv = document.getElementById('logOutput');
        const line = document.createElement('div');
        line.className = 'header';
        line.textContent = '\n=== Container creation complete ===\n';
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
        
        // Update status message
        const statusMessage = document.getElementById('statusMessage');
        const successCount = data.results ? data.results.filter(r => r.success).length : 0;
        const totalCount = data.results ? data.results.length : 0;
        statusMessage.textContent = `Completed: ${successCount}/${totalCount} containers created successfully`;
        
        document.getElementById('logStatus').textContent = 'Completed';
        document.getElementById('logStatus').style.color = '#51cf66';
    });
    
    // Start container creation via WebSocket
    socket.emit('create_containers', data);
}

function cancelCreation() {
    if (confirm('Are you sure you want to cancel container creation?')) {
        if (socket) {
            socket.disconnect();
        }
        document.getElementById('creatingOverlay').style.display = 'none';
        creationInProgress = false;
    }
}

function closeOverlay() {
    if (socket) {
        socket.disconnect();
    }
    window.location.href = '/';
}

function addProgressItem(id, text) {
    const progressList = document.getElementById('progressList');
    const item = document.createElement('div');
    item.className = 'progress-item';
    item.id = 'progress-' + id;
    item.innerHTML = `
        <svg class="progress-icon pending" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
        </svg>
        <span>${text}</span>
    `;
    progressList.appendChild(item);
}

function updateProgressItem(id, success, message) {
    const item = document.getElementById('progress-' + id);
    if (item) {
        const icon = item.querySelector('.progress-icon');
        const text = item.querySelector('span');
        
        if (success) {
            icon.className = 'progress-icon success';
            icon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
            text.textContent = message || 'Success';
        } else {
            icon.className = 'progress-icon error';
            icon.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>';
            text.textContent = message || 'Failed';
        }
    }
}

// Initialize
updateAppContainersList();
updateSummary();
</script>
{% endblock %}