{% extends "base.html" %}

{% block title %}Shell - {{ container_name }} - LXC Compose Manager{% endblock %}

{% block extra_css %}
<style>
    #terminal {
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;
        font-size: 14px;
        padding: 10px;
        height: 600px;
        overflow-y: auto;
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
        cursor: text;
        position: relative;
    }
    
    #terminal:focus {
        outline: none;
    }
    
    .cursor {
        display: inline-block;
        width: 8px;
        height: 16px;
        background: #d4d4d4;
        animation: blink 1s infinite;
        vertical-align: text-bottom;
        margin-left: 2px;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }
    
    .current-line {
        display: inline;
    }
    
    .terminal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 5px 5px 0 0;
        margin-bottom: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .terminal-title {
        font-size: 18px;
        font-weight: 500;
    }
    
    .terminal-info {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .input-group {
        display: flex;
        margin-top: 10px;
        align-items: stretch;
    }
    
    #promptLabel {
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
    }
    
    #commandInput {
        flex: 1;
        padding: 10px;
        background: #2d2d2d;
        color: #d4d4d4;
        border: 1px solid #444;
        border-left: none;
        font-family: monospace;
        font-size: 14px;
    }
    
    #commandInput:focus {
        outline: none;
        border-color: #667eea;
    }
    
    #sendButton {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 0 3px 3px 0;
        cursor: pointer;
        font-weight: 500;
    }
    
    #sendButton:hover {
        background: #5a67d8;
    }
    
    .terminal-line {
        margin: 2px 0;
    }
    
    .terminal-prompt {
        color: #4fc3f7;
        font-weight: bold;
    }
    
    .terminal-output {
        color: #d4d4d4;
    }
    
    .terminal-error {
        color: #f44336;
    }
    
    .terminal-success {
        color: #4caf50;
    }
    
    .connection-status {
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-connected {
        background: #4caf50;
        color: white;
    }
    
    .status-disconnected {
        background: #f44336;
        color: white;
    }
    
    .status-connecting {
        background: #ff9800;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="terminal-header">
    <div>
        <div class="terminal-title">Container Shell: {{ container_name }}</div>
        <div class="terminal-info">Interactive shell session</div>
    </div>
    <div>
        <span id="connectionStatus" class="connection-status status-disconnected">Disconnected</span>
    </div>
</div>

<div id="terminal" tabindex="0"></div>

<div style="margin-top: 15px;">
    <button class="btn btn-secondary" onclick="clearTerminal()">Clear</button>
    <button class="btn btn-secondary" onclick="window.close()">Close</button>
    <button class="btn btn-primary" onclick="connectShell()">Reconnect</button>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const containerName = '{{ container_name }}';
    const sessionId = '{{ session_id }}';
    let currentWorkingDir = '/root';
    let currentCommand = '';
    let commandHistory = [];
    let historyIndex = -1;
    const terminal = document.getElementById('terminal');
    const connectionStatus = document.getElementById('connectionStatus');
    const promptLabel = document.getElementById('promptLabel');
    
    function updateConnectionStatus(status) {
        connectionStatus.className = 'connection-status';
        switch(status) {
            case 'connected':
                connectionStatus.textContent = 'Connected';
                connectionStatus.classList.add('status-connected');
                break;
            case 'disconnected':
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.classList.add('status-disconnected');
                break;
            case 'connecting':
                connectionStatus.textContent = 'Connecting...';
                connectionStatus.classList.add('status-connecting');
                break;
        }
    }
    
    function appendToTerminal(text, className = 'terminal-output') {
        const line = document.createElement('div');
        line.className = `terminal-line ${className}`;
        line.textContent = text;
        
        // Remove any existing input line before adding new content
        const existingInputLine = terminal.querySelector('.input-line');
        if (existingInputLine) {
            existingInputLine.remove();
        }
        
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
    }
    
    function showInputLine() {
        // Remove any existing input line
        const existingInputLine = terminal.querySelector('.input-line');
        if (existingInputLine) {
            existingInputLine.remove();
        }
        
        // Create new input line with prompt and current command
        const inputLine = document.createElement('div');
        inputLine.className = 'terminal-line input-line';
        inputLine.style.display = 'flex';
        inputLine.style.alignItems = 'center';
        
        const prompt = document.createElement('span');
        prompt.className = 'terminal-prompt';
        prompt.textContent = getPrompt();
        prompt.style.marginRight = '5px';
        
        const commandText = document.createElement('span');
        commandText.textContent = currentCommand;
        commandText.style.color = '#d4d4d4';
        
        const cursor = document.createElement('span');
        cursor.className = 'cursor';
        cursor.textContent = '\u00A0'; // Non-breaking space
        
        inputLine.appendChild(prompt);
        inputLine.appendChild(commandText);
        inputLine.appendChild(cursor);
        
        terminal.appendChild(inputLine);
        terminal.scrollTop = terminal.scrollHeight;
    }
    
    function connectShell() {
        updateConnectionStatus('connecting');
        
        appendToTerminal(`Connecting to container ${containerName}...`, 'terminal-success');
        updateConnectionStatus('connected');
        
        // Show welcome message with limitations
        appendToTerminal('═══════════════════════════════════════════════════════════════', 'terminal-output');
        appendToTerminal('                    Web Shell - Restricted Mode', 'terminal-success');
        appendToTerminal('═══════════════════════════════════════════════════════════════', 'terminal-output');
        appendToTerminal('', 'terminal-output');
        appendToTerminal('⚠️  This is a restricted, non-interactive shell with limitations:', 'terminal-output');
        appendToTerminal('', 'terminal-output');
        appendToTerminal('❌ Interactive commands will NOT work:', 'terminal-error');
        appendToTerminal('   • top, htop (use: ps aux)', 'terminal-output');
        appendToTerminal('   • vi, vim, nano (edit files locally instead)', 'terminal-output');
        appendToTerminal('   • less, more (use: cat or head/tail)', 'terminal-output');
        appendToTerminal('   • tail -f (use: tail -n 20)', 'terminal-output');
        appendToTerminal('   • Interactive installers', 'terminal-output');
        appendToTerminal('', 'terminal-output');
        appendToTerminal('✅ Commands that WILL work:', 'terminal-success');
        appendToTerminal('   • Navigation: ls, cd, pwd', 'terminal-output');
        appendToTerminal('   • File viewing: cat, head, tail, grep', 'terminal-output');
        appendToTerminal('   • Process info: ps, ps aux, kill', 'terminal-output');
        appendToTerminal('   • Network: ping, curl, wget', 'terminal-output');
        appendToTerminal('   • Package management: apt update, apt install -y', 'terminal-output');
        appendToTerminal('   • Most other non-interactive commands', 'terminal-output');
        appendToTerminal('', 'terminal-output');
        appendToTerminal('💡 For full shell access, SSH to the host and use:', 'terminal-output');
        appendToTerminal(`   sudo lxc-attach -n ${containerName}`, 'terminal-output');
        appendToTerminal('', 'terminal-output');
        appendToTerminal('═══════════════════════════════════════════════════════════════', 'terminal-output');
        appendToTerminal('', 'terminal-output');
        
        // Update the prompt label instead of showing in terminal
        updatePrompt();
    }
    
    function getPrompt() {
        const shortPath = currentWorkingDir.replace('/root', '~');
        return `root@${containerName}:${shortPath}#`;
    }
    
    function updatePrompt() {
        promptLabel.textContent = getPrompt();
    }
    
    function sendCommand() {
        const command = commandInput.value.trim();
        if (!command) return;
        
        // Show the command that was executed
        appendToTerminal(getPrompt() + ' ' + command, 'terminal-prompt');
        
        // Check for interactive commands that won't work
        const interactiveCommands = ['top', 'htop', 'less', 'more', 'vi', 'vim', 'nano', 'emacs', 'tail -f', 'watch'];
        const isInteractive = interactiveCommands.some(cmd => command.startsWith(cmd));
        
        if (isInteractive) {
            const cmdName = command.split(' ')[0];
            appendToTerminal(`❌ '${cmdName}' is an interactive command and won't work in this restricted shell.`, 'terminal-error');
            
            // Provide specific alternatives
            if (command.startsWith('top') || command.startsWith('htop')) {
                appendToTerminal(`💡 Use: ps aux --sort=-%cpu`, 'terminal-success');
            } else if (command.startsWith('tail -f')) {
                const file = command.split(' ')[2] || '<file>';
                appendToTerminal(`💡 Use: tail -n 20 ${file}`, 'terminal-success');
            } else if (command.startsWith('less') || command.startsWith('more')) {
                const file = command.split(' ')[1] || '<file>';
                appendToTerminal(`💡 Use: cat ${file} | head -50`, 'terminal-success');
            } else if (command.startsWith('vi') || command.startsWith('vim') || command.startsWith('nano')) {
                appendToTerminal(`💡 Edit files locally or use: cat > file.txt << EOF`, 'terminal-success');
            }
            
            commandInput.value = '';
            commandInput.focus();
            return;
        }
        
        // Execute command via API with session ID
        fetch('/api/command/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                command: `execute ${containerName} ${command}`,
                session_id: sessionId
            })
        })
        .then(response => response.json())
        .then(data => {
            // Update working directory if it changed
            if (data.working_dir) {
                currentWorkingDir = data.working_dir;
                updatePrompt();
            }
            
            if (data.success) {
                if (data.stdout) {
                    appendToTerminal(data.stdout);
                }
                if (data.stderr && data.stderr.trim()) {
                    // Only show stderr if it's not empty
                    appendToTerminal(data.stderr, 'terminal-error');
                }
            } else if (data.error) {
                // Only show error if there's an actual error message
                appendToTerminal(`Error: ${data.error}`, 'terminal-error');
            } else if (data.stdout || data.stderr) {
                // If we have output but success is false, still show the output
                if (data.stdout) {
                    appendToTerminal(data.stdout);
                }
                if (data.stderr) {
                    appendToTerminal(data.stderr, 'terminal-error');
                }
            }
        })
        .catch(error => {
            appendToTerminal(`Error: ${error.message}`, 'terminal-error');
        });
        
        commandInput.value = '';
        commandInput.focus();
    }
    
    function clearTerminal() {
        terminal.innerHTML = '';
        appendToTerminal(`Terminal cleared`, 'terminal-success');
    }
    
    // Event listeners
    sendButton.addEventListener('click', sendCommand);
    commandInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendCommand();
        }
    });
    
    // Connect on load
    window.addEventListener('load', () => {
        connectShell();
    });
</script>
{% endblock %}