{% extends "base.html" %}

{% block title %}Terminal - LXC Compose Manager{% endblock %}

{% block extra_css %}
<style>
    .nav-bar {
        background: white;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .nav-links {
        display: flex;
        gap: 20px;
    }
    
    .nav-link {
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: color 0.3s;
    }
    
    .nav-link:hover {
        color: #764ba2;
    }
    
    .nav-link.active {
        font-weight: 600;
        color: #333;
    }
    
    .terminal-container {
        background: #1e1e1e;
        border-radius: 10px;
        padding: 20px;
        min-height: 500px;
        font-family: 'Courier New', monospace;
    }
    
    .terminal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #333;
    }
    
    .terminal-title {
        color: #fff;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .terminal-buttons {
        display: flex;
        gap: 8px;
    }
    
    .terminal-btn {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
    }
    
    .terminal-btn.close {
        background: #ff5f56;
    }
    
    .terminal-btn.minimize {
        background: #ffbd2e;
    }
    
    .terminal-btn.maximize {
        background: #27c93f;
    }
    
    .terminal-output {
        color: #d4d4d4;
        font-size: 14px;
        line-height: 1.5;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
    }
    
    .terminal-line {
        margin: 2px 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .terminal-line.command {
        color: #61dafb;
    }
    
    .terminal-line.error {
        color: #ff6b6b;
    }
    
    .terminal-line.success {
        color: #51cf66;
    }
    
    .terminal-input-wrapper {
        display: flex;
        align-items: center;
        background: #2d2d2d;
        border-radius: 5px;
        padding: 10px;
    }
    
    .terminal-prompt {
        color: #51cf66;
        margin-right: 10px;
        font-weight: bold;
    }
    
    .terminal-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        outline: none;
    }
    
    .command-hints {
        background: #2d2d2d;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .command-hints h4 {
        color: #61dafb;
        margin-bottom: 10px;
        font-size: 14px;
    }
    
    .command-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
    }
    
    .command-item {
        color: #d4d4d4;
        font-size: 13px;
        padding: 5px;
        background: #1e1e1e;
        border-radius: 3px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .command-item:hover {
        background: #333;
    }
    
    .command-item code {
        color: #61dafb;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation Bar -->
<div class="nav-bar">
    <div class="nav-links">
        <a href="{{ url_for('index') }}" class="nav-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            Dashboard
        </a>
        <a href="{{ url_for('wizard') }}" class="nav-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
            </svg>
            Create Containers
        </a>
        <a href="{{ url_for('terminal') }}" class="nav-link active">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 17 10 11 4 5"></polyline>
                <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            Terminal
        </a>
    </div>
    <div style="color: #666; font-size: 12px;">
        Host IP: {{ host_ip }}
    </div>
</div>

<div class="terminal-container">
    <div class="terminal-header">
        <div class="terminal-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 17 10 11 4 5"></polyline>
                <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            LXC Compose Terminal
        </div>
        <div class="terminal-buttons">
            <button class="terminal-btn close" onclick="window.close()"></button>
            <button class="terminal-btn minimize"></button>
            <button class="terminal-btn maximize" onclick="toggleFullscreen()"></button>
        </div>
    </div>
    
    <div class="terminal-output" id="terminalOutput">
        <div class="terminal-line">Welcome to LXC Compose Terminal</div>
        <div class="terminal-line">Type 'help' for available commands</div>
        <div class="terminal-line">────────────────────────────────────────</div>
    </div>
    
    <div class="terminal-input-wrapper">
        <span class="terminal-prompt">lxc-compose&gt;</span>
        <input type="text" 
               class="terminal-input" 
               id="terminalInput" 
               autofocus 
               autocomplete="off"
               placeholder="Enter command...">
    </div>
</div>

<div class="command-hints">
    <h4>Quick Commands</h4>
    <div class="command-list">
        <div class="command-item" onclick="runCommand('list')">
            <code>list</code> - List all containers
        </div>
        <div class="command-item" onclick="runCommand('doctor')">
            <code>doctor</code> - System health check
        </div>
        <div class="command-item" onclick="runCommand('update')">
            <code>update</code> - Update LXC Compose
        </div>
        <div class="command-item" onclick="runCommand('test db')">
            <code>test db</code> - Test PostgreSQL
        </div>
        <div class="command-item" onclick="runCommand('test redis')">
            <code>test redis</code> - Test Redis
        </div>
        <div class="command-item" onclick="setCommand('attach ')">
            <code>attach [name]</code> - Container shell
        </div>
        <div class="command-item" onclick="setCommand('execute ')">
            <code>execute [container] [cmd]</code> - Run command
        </div>
        <div class="command-item" onclick="runCommand('help')">
            <code>help</code> - Show all commands
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const output = document.getElementById('terminalOutput');
const input = document.getElementById('terminalInput');
let commandHistory = [];
let historyIndex = -1;

// Focus input on click
document.querySelector('.terminal-container').addEventListener('click', () => {
    input.focus();
});

// Handle input
input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const command = input.value.trim();
        if (command) {
            executeCommand(command);
            commandHistory.push(command);
            historyIndex = commandHistory.length;
        }
        input.value = '';
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (historyIndex > 0) {
            historyIndex--;
            input.value = commandHistory[historyIndex];
        }
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            input.value = commandHistory[historyIndex];
        } else {
            historyIndex = commandHistory.length;
            input.value = '';
        }
    }
});

function addLine(text, className = '') {
    const line = document.createElement('div');
    line.className = 'terminal-line ' + className;
    line.textContent = text;
    output.appendChild(line);
    output.scrollTop = output.scrollHeight;
}

function executeCommand(command) {
    addLine('$ ' + command, 'command');
    
    if (command === 'help') {
        showHelp();
        return;
    }
    
    if (command === 'clear') {
        output.innerHTML = '';
        return;
    }
    
    // Send command to server
    fetch('/api/command/execute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({command: command})
    })
    .then(response => response.json())
    .then(data => {
        if (data.redirect) {
            window.open(data.redirect, '_blank');
            addLine('Opening shell in new window...', 'success');
        } else if (data.success) {
            if (data.stdout) {
                data.stdout.split('\n').forEach(line => {
                    if (line) addLine(line);
                });
            }
            if (data.stderr) {
                data.stderr.split('\n').forEach(line => {
                    if (line) addLine(line, 'error');
                });
            }
        } else {
            addLine('Error: ' + (data.error || 'Command failed'), 'error');
        }
    })
    .catch(error => {
        addLine('Error: ' + error, 'error');
    });
}

function showHelp() {
    const helpText = `
Available Commands:
───────────────────────────────────────
  list                 - List all containers
  doctor               - Run system health check
  update               - Update LXC Compose
  
  attach [name]        - Open shell in container
  execute [name] [cmd] - Execute command in container
  
  start [name]         - Start a container
  stop [name]          - Stop a container
  restart [name]       - Restart a container
  
  test db              - Test PostgreSQL connection
  test redis           - Test Redis connection
  
  clear                - Clear terminal
  help                 - Show this help
───────────────────────────────────────`;
    
    helpText.trim().split('\n').forEach(line => addLine(line));
}

function runCommand(cmd) {
    input.value = cmd;
    executeCommand(cmd);
}

function setCommand(cmd) {
    input.value = cmd;
    input.focus();
    input.setSelectionRange(cmd.length, cmd.length);
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}
</script>
{% endblock %}