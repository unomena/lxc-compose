# PostgreSQL Server (Docker-style) - Ubuntu Minimal 22.04
# Lightweight PostgreSQL on Ubuntu Minimal
# Usage: POSTGRES_PASSWORD=mysecret lxc-compose up

version: '1.0'

containers:
  postgresql-minimal-22-04:
    template: ubuntu-minimal-22.04
    
    exposed_ports:
      - 5432
    
    packages:
      - postgresql
      - postgresql-client
    
    tests:
      external:
        - crud:/tests/test.sh
    
    post_install:
      - name: "Setup PostgreSQL"
        command: |
          # Create run directory
          mkdir -p /run/postgresql
          chown postgres:postgres /run/postgresql
          
          # Initialize database
          sudo -u postgres /usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main
          
          # Configure for network access
          echo "host all all 0.0.0.0/0 md5" >> /var/lib/postgresql/14/main/pg_hba.conf
          echo "listen_addresses = '*'" >> /var/lib/postgresql/14/main/postgresql.conf
          
          # Start PostgreSQL
          sudo -u postgres /usr/lib/postgresql/14/bin/pg_ctl -D /var/lib/postgresql/14/main start
          sleep 3
          
          # Set password from environment (Docker-style)
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
          sudo -u postgres psql -c "ALTER USER postgres PASSWORD '$POSTGRES_PASSWORD';"
          
          # Create database if specified
          POSTGRES_DB=${POSTGRES_DB:-}
          if [ -n "$POSTGRES_DB" ] && [ "$POSTGRES_DB" != "postgres" ]; then
            sudo -u postgres createdb $POSTGRES_DB
          fi
          
          # Create user if specified  
          POSTGRES_USER=${POSTGRES_USER:-}
          if [ -n "$POSTGRES_USER" ] && [ "$POSTGRES_USER" != "postgres" ]; then
            sudo -u postgres psql -c "CREATE USER $POSTGRES_USER WITH PASSWORD '$POSTGRES_PASSWORD';"
            if [ -n "$POSTGRES_DB" ]; then
              sudo -u postgres psql -c "GRANT ALL ON DATABASE $POSTGRES_DB TO $POSTGRES_USER;"
            fi
          fi
          
          echo "PostgreSQL is ready!"
          sudo -u postgres psql -l    
    logs:
      - postgresql:/var/log/postgresql/postgresql.log
