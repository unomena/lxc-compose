# Rabbitmq Server - Ubuntu-Minimal 22.04
# Rabbitmq on Ubuntu-Minimal 22.04
# Usage: lxc-compose up

version: '1.0'

containers:
  rabbitmq-minimal-22-04:
    template: ubuntu-minimal-22.04
    
    exposed_ports:
      - 5672
      - 15672
    
    packages:
      - rabbitmq-server

    tests:
      external:
        - rabbitmq:/tests/rabbitmq.sh
    
    post_install:
      - name: "Setup Rabbitmq"
        command: |
          # Configure and start RabbitMQ
          # Enable management plugin
          rabbitmq-plugins enable rabbitmq_management
          
          # Start RabbitMQ manually
          /usr/sbin/rabbitmq-server -detached
          
          # Wait for RabbitMQ to start
          sleep 15
          
          # Create admin user
          rabbitmqctl add_user admin admin || true
          rabbitmqctl set_user_tags admin administrator || true
          rabbitmqctl set_permissions -p / admin ".*" ".*" ".*" || true
          echo "Rabbitmq is ready!"
    
    logs:
      - rabbitmq:/var/log/rabbitmq/rabbit.log
      - startup:/var/log/rabbitmq/startup_log
